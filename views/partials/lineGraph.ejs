<link rel="stylesheet" type="text/css" href="/stylesheets/chartistCustom.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

<div class="card">
    <div class="card-body">
        <h2 class="card-title">Mood</h2>

        <div class="ui hidden divider"></div>
        <a onclick="refresh()" class="ui primary button">Update graph</a>

        <canvas id="myChart" width="600" height="300"></canvas>
    </div>
</div>

<script>

    var entries = <%- JSON.stringify(entries) %>;
    
    function refresh() {
        var term1 = "ORDER" // document.querySelector("input[name='category1']").value,
            term2 = "CHAOS" // document.querySelector("input[name='category2']").value,
            term3 = "LENGTH (WORDS)" // document.querySelector("input[name='category3']").value,
            total1 = 0,
            total2 = 0,
            total3 = 0,
            arr1 = [],
            arr2 = [],
            arr3 = [],
            labelArr = [];
            console.log(term3);
            
        entries.forEach(function(entry) {
            total1 += entry.metadata.ri[term1] / entry.body.length; // so that longer entries aren't weighted heavier
            total2 += entry.metadata.ri[term2] / entry.body.length;
            if (term3 === "LENGTH (WORDS)") {
                total3 += entry.body.split(" ").length;
            }
        });
        
        var avg1 = total1 / entries.length,
            avg2 = total2 / entries.length,
            avg3;
            
        if (term3 === "LENGTH (WORDS)") {
            avg3 = total3 / entries.length;
        }
    
        entries.forEach(function(entry, index) {
            arr1.push(entry.metadata.ri[term1] / entry.body.length - avg1);
            arr2.push(entry.metadata.ri[term2] / entry.body.length - avg2);
            if (term3 === "LENGTH (WORDS)") {
                arr3.push(entry.body.split(" ").length);
            }
            labelArr.push(entry.date);
        });

       
    
        var ctx = document.getElementById("myChart").getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labelArr,
                datasets: [
                    {
                        label: term1,
                        data: arr1,
                        backgroundColor: 'transparent',
                        borderColor: 'lightblue',
                        borderWidth: 1,
                        borderCapStyle: "round",
                        borderJoinStyle: "round",
                        pointBackgroundColor: 'lightblue',
                        pointHoverRadius: 2,
                        spanGaps: false,
                        yAxisID: 'y-axis-1'
                    },
                    {
                        label: term2,
                        data: arr2,
                        backgroundColor: 'transparent',
                        borderColor: 'red',
                        borderWidth: 1,
                        borderCapStyle: "round",
                        borderJoinStyle: "round",
                        pointBackgroundColor: 'red',
                        pointHoverRadius: 2,
                        spanGaps: false,
                        yAxisID: 'y-axis-2'
                    },
                    {
                        label: term3,
                        data: arr3,
                        backgroundColor: 'transparent',
                        borderColor: 'white',
                        borderWidth: 1,
                        borderCapStyle: "round",
                        borderJoinStyle: "round",
                        pointBackgroundColor: 'white',
                        pointHoverRadius: 2,
                        spanGaps: false,
                        yAxisID: "y-axis-3"
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    xAxes: [{
                        display: false
                    }],
                    yAxes: [{
                        type: 'linear',
                        ticks: {
                            beginAtZero:true
                        },
                        position: 'left',
                        id: 'y-axis-1'
                    },
                    {
                        type: 'linear',
                        ticks: {
                            beginAtZero:true
                        },
                        position: 'left',
                        id: 'y-axis-2'
                    },
                    {
                        type: 'linear',
                        ticks: {
                            beginAtZero:true
                        },
                        position: 'right',
                        id: 'y-axis-3',
                        scaleLabel: {
                            labelString: 'Words'
                        }
                    }]
                },
                tooltips: {
                    mode: 'index',
                    intersect: false
                }
            }
        });
    
    }
    
    $('.ui.dropdown')
        .dropdown()
    ;
    
    </script>